<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Service Resiliency :: Istio Tutorial Docs</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/istio-tutorial/istio-tutorial/1.9.x/5circuit-breaker.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/istio-tutorial">Istio Tutorial Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="istio-tutorial" data-version="1.9.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction to Istio Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="1setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#download-tutorial-sources">Download Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#install-minikube">Install Minikube</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#start-kubernetes">Start Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#istioinstallation">Install Istio</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="2deploy-microservices.html">2. Deploy Microservices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2deploy-microservices.html#deploycustomer">Deploy Customer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2deploy-microservices.html#deploypreference">Deploy Preference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2deploy-microservices.html#deployrecommendation">Deploy Recommendation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2deploy-microservices.html#redeployingcode">Updating Redeploying Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="3monitoring-tracing.html">3. Observability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3monitoring-tracing.html#monitoring">Monitoring with Grafana</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="3monitoring-tracing.html#prometheus">Prometheus</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3monitoring-tracing.html#custommetrics">Custom metrics</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3monitoring-tracing.html#containermemory">Container memory</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3monitoring-tracing.html#applicationmetrics">Application metrics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3monitoring-tracing.html#tracing">Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="3kiali.html">Kiali</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3kiali.html#howkiali">How Kiali Work</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3kiali.html#updatekiali">Update Kiali</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3kiali.html#generatingdata">Generating Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3kiali.html#servicegraph">Service Graph</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3kiali.html#servicelistening">Service Listening</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3kiali.html#istioconf">Istio Config</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3kiali.html#distributedtracing">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="3kiali.html#cleanup">Uninstall Kiali</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Traffic Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="4simple-routerules.html">Simple Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="4simple-routerules.html#deployrecommendationv2">Deploy Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="4simple-routerules.html#istiorouting">Changing Istio Routings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="4simple-routerules.html#alltorecommendationv2">All Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="4simple-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="4simple-routerules.html#alltorecommendationv1v2">All Users To Recommendation V1 and V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="4simple-routerules.html#canarydeploymentrecommendation">Canary Deployment Between v1 And v2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="4advanced-routerules.html">Advanced Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="4advanced-routerules.html#canarydeploymentuseragent">Canary Deployment based on user-agent</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="4advanced-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="4advanced-routerules.html#safaritov2">All Safari Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="4advanced-routerules.html#mobiletov2">All Mobile Users To Recommendation V2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="4advanced-routerules.html#mirroringtraffic">Mirroring Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="4advanced-routerules.html#loadbalancer">Load Balancer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="5circuit-breaker.html">5. Service Resiliency</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#retry">Retry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#timeout">Timeout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#failfast">Fail Fast</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#nocircuitbreaker">No Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#circuitbreaker">Circuit Breaker</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="6fault-injection.html">6. Chaos Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6fault-injection.html#503error">HTTP 503 Error</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6fault-injection.html#delay">Delay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">7. Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="8egress.html">Egress</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="8egress.html#createrecommendationv3">Create Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="8egress.html#istioegress">Istio-ize Egress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="8acl.html">Access Control</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="8acl.html#authpolicies">Authorization Policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="8mTLS.html">Mutual TLS and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="8mTLS.html#testingtls">Testing mTLS</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="8jwt.html">End-user authentication with JWT</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="8jwt.html#enablingauthentication">Enabling end-user authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="8jwt.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="8rbac.html">Istio Role Based Access Control (RBAC)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="8rbac.html#authorization-jwt">Authorization and JWT</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="8rbac.html#final-notes">Final Notes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="8rbac.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#8tips.adoc">10. Tips And Tricks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="advanced/index.html">Advanced Istio Tutorial</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="advanced/virtualization.html">Service Virtualization and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/virtualization.html#deploypreferencev2">Deploy Preference V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/virtualization.html#servicevirtualization">Adding Service Virtualization</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/virtualization.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="advanced/diferencia.html">Diferencia and Detecting Regressions</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/diferencia.html#what-is-diferencia">What is Diferencia?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/diferencia.html#master-candidate">Setting Master Candidate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/diferencia.html#deploying-diferencia">Deploying Diferencia</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/diferencia.html#shadowing-traffic">Shadowing Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/diferencia.html#noise-detection">Noise Detection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/diferencia.html#cleanup">Clean up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="advanced/promotion.html">Istio for Promoting Services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/promotion.html#what-is-promotion">What is Promotion?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/promotion.html#deploy-recommendation-v3">Deploy Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/promotion.html#feature-graduation]">Feature Graduation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/promotion.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="advanced/zero-downtime-database.html">Zero Downtime Migration with Database</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Starting the Migration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="advanced/zero-downtime-database.html#recommendationv4">Deploy Recommendation V4</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="advanced/zero-downtime-database.html#recommendationv5">Deploy Recommendation V5</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="advanced/zero-downtime-database.html#recommendationv6">Deploy Recommendation V6</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="advanced/zero-downtime-database.html#recommendationv7">Deploy Recommendation V7</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/zero-downtime-database.html#finalstep">Final Step</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/zero-downtime-database.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="advanced/cube.html">Dark Launch Automatic Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/cube.html#preparation">Preparation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/cube.html#explanation">Explanation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/cube.html#code">Source Code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced/cube.html#restore">Restore Environment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Istio Tutorial</a></li>
    <li><a href="5circuit-breaker.html">5. Service Resiliency</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/istio-tutorial/edit/master/documentation/modules/ROOT/pages/5circuit-breaker.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Service Resiliency</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Before Start</div>
<div class="paragraph">
<p>You should have NO virtualservice nor destinationrule (in <code>tutorial</code> namespace) <code>kubectl get virtualservice</code> <code>kubectl get destinationrule</code>
if so run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh tutorial</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="retry"><a class="anchor" href="#retry"></a>Retry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Instead of failing immediately, retry the Service N more times</p>
</div>
<div class="paragraph">
<p>We will make pod recommendation-v2 fail 100% of the time. Get one of the pod names from your system and replace on the following command accordingly:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl exec -it -n tutorial $(kubectl get pods -n tutorial|grep recommendation-v2|awk '{ print $1 }'|head -1) -c recommendation /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will be inside the application container of your pod <code>recommendation-v2-2036617847-spdrb</code>. Now execute:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/misbehave
exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a special endpoint that will make our application return only `503`s.</p>
</div>
<div class="paragraph">
<p>You will see it works every time because Istio will retry the recommendation service <strong>automatically</strong> and it will land on v1 only.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/run.sh $GATEWAY_URL/customer</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">customer =&gt; preference =&gt; recommendation v1 from 'recommendation-v1-2036617847-m9glz': 196
customer =&gt; preference =&gt; recommendation v1 from 'recommendation-v1-2036617847-m9glz': 197
customer =&gt; preference =&gt; recommendation v1 from 'recommendation-v1-2036617847-m9glz': 198</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you open Kiali, you will notice that v2 receives requests, but that failing request is never returned to the user as <code>preference</code> will retry to establish the connection with <code>recommendation</code>, and v1 will reply.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset1_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl dashboard kiali</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_openshift">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get route kiali -n istio-system --output 'jsonpath={.status.ingress[].host}'</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In Kiali, go to <code>Graph</code>, select the <code>recommendation</code> square, and place the mouse over the red sign, like the picture bellow.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/kiali-retry.png" alt="Kiali Retry"></span></p>
</div>
<div class="paragraph">
<p>Now, make the pod v2 behave well again</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl exec -it -n tutorial $(kubectl get pods -n tutorial|grep recommendation-v2|awk '{ print $1 }'|head -1) -c recommendation /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will be inside the application container of your pod <code>recommendation-v2-2036617847-spdrb</code>. Now execute:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/behave
exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application is back to round-robin load-balancing between v1 and v2</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/run.sh $GATEWAY_URL/customer</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">customer =&gt; preference =&gt; recommendation v1 from 'recommendation-v1-2039379827-h58vw': 129
customer =&gt; preference =&gt; recommendation v2 from 'recommendation-v2-2036617847-m9glz': 207
customer =&gt; preference =&gt; recommendation v1 from 'recommendation-v1-2039379827-h58vw': 130</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="timeout"><a class="anchor" href="#timeout"></a>Timeout</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wait only N seconds before giving up and failing. At this point, no other virtual service nor destination rule (in <code>tutorial</code> namespace) should be in effect.</p>
</div>
<div class="paragraph">
<p>To check it run <code>kubectl get virtualservice</code> and <code>kubectl get destinationrule</code> and if it is necessary run  <code>kubectl delete virtualservice virtualservicename -n tutorial</code> and <code>kubectl delete destinationrule destinationrulename -n tutorial</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will deploy docker images that were previously built for this tutorial. If you want to build recommendation with Quarkus to add a timeout visit: <a href="2build-microservices.html#buildrecommendationv2-timeout" class="page">Modify recommendation:v2 to have timeout</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will deploy docker images that were previously built for this tutorial. If you want to build recommendation with Spring Boot to add a timeout visit: <a href="2build-microservices.html#buildrecommendationspringbootv2-timeout" class="page">Modify recommendation:v2 Spring Boot to have timeout</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you <strong>have not built</strong> the images on your own then let&#8217;s deploy the customer pod with its sidecar using the already built images for this tutorial:</p>
</div>
<div class="paragraph">
<p>First, introduce some wait time in <code>recommendation v2</code> by making it a slow performer with a 3 second delay by running the command</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl patch deployment recommendation-v2 -p '{"spec":{"template":{"spec":{"containers":[{"name":"recommendation", "image":"quay.io/rhdevelopers/istio-tutorial-recommendation:v2-timeout"}]}}}}' -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hit the customer endpoint a few times, to see the load-balancing between v1 and v2 but with v2 taking a bit of time to respond</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/run.sh $GATEWAY_URL/customer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add the timeout rule</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-timeout.yml">istiofiles/virtual-service-recommendation-timeout.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see it return v1 after waiting about 1 second. You don&#8217;t see v2 anymore, because the response from v2 expires after the timeout period and it is never returned.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/run.sh $GATEWAY_URL/customer</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">customer =&gt; preference =&gt; recommendation v1 from 'recommendation-v1-6976858b48-cs2rt': 2907
customer =&gt; preference =&gt; recommendation v1 from 'recommendation-v1-6976858b48-cs2rt': 2908
customer =&gt; preference =&gt; recommendation v1 from 'recommendation-v1-6976858b48-cs2rt': 2909</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_clean_up"><a class="anchor" href="#_clean_up"></a>Clean up</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will deploy docker images that were previously built. If you want to build recommendation with Quarkus to remove the timeout visit: <a href="2build-microservices.html#timeout-clenup" class="page">Modify recommendation:v2 to remove timeout</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will deploy docker images that were previously built. If you want to build recommendation with Spring Boot to remove the timeout visit: <a href="2build-microservices.html#timeoutspringboot-cleanup" class="page">Modify recommendation:v2 to remove timeout</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Change the implementation of <code>v2</code> back to the image that responds without the delay of 3 seconds:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl patch deployment recommendation-v2 -p '{"spec":{"template":{"spec":{"containers":[{"name":"recommendation", "image":"quay.io/rhdevelopers/istio-tutorial-recommendation:v2"}]}}}}' -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then delete the virtual service created for timeout by:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f istiofiles/virtual-service-recommendation-timeout.yml -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>or you can run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh tutorial</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="failfast"><a class="anchor" href="#failfast"></a>Fail Fast with Max Connections and Max Pending Requests</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="nocircuitbreaker"><a class="anchor" href="#nocircuitbreaker"></a>Load test without circuit breaker</h3>
<div class="paragraph">
<p>Let&#8217;s perform a load test in our system with <code>siege</code>. We&#8217;ll have 10 clients sending 4 concurrent requests each:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">siege -r 10 -c 4 -v $GATEWAY_URL/customer</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see an output similar to this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/siege_ok.png" alt="siege output with all successful requests"></span></p>
</div>
<div class="paragraph">
<p>All of the requests to our system were successful.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s make things a bit more interesting.</p>
</div>
<div class="paragraph">
<p>We will make pod <code>recommendation-v2</code> fail 100% of the time.
Get one of the pod names from your system and replace on the following command accordingly:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl exec -it -n tutorial $(kubectl get pods -n tutorial|grep recommendation-v2|awk '{ print $1 }'|head -1) -c recommendation /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will be inside the application container of your pod <code>recommendation-v2-2036617847-spdrb</code>. Now execute:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/misbehave
exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open a new terminal window and run next command to inspect the logs of this failing pod:</p>
</div>
<div class="paragraph">
<p>First you need the pod name:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods -n tutorial</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                  READY     STATUS    RESTARTS   AGE
customer-3600192384-fpljb             2/2       Running   0          17m
preference-243057078-8c5hz           2/2       Running   0          15m
recommendation-v1-60483540-9snd9     2/2       Running   0          12m
recommendation-v2-2815683430-vpx4p   2/2       Running   0         15s</code></pre>
</div>
</div>
<div class="paragraph">
<p>And get the pod name of <code>recommendation-v2</code>.
In previous case, it is <code>recommendation-v2-2815683430-vpx4p</code>.</p>
</div>
<div class="paragraph">
<p>Then check its log:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl logs recommendation-v2-2815683430-vpx4p -c recommendation -n tutorial</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">recommendation request from 'recommendation-v2-2815683430-vpx4p': 10
recommendation request from 'recommendation-v2-2815683430-vpx4p': 11
recommendation request from 'recommendation-v2-2815683430-vpx4p': 12
recommendation request from 'recommendation-v2-2815683430-vpx4p': 13</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scale up the recommendation v2 service to two instances:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl scale deployment recommendation-v2 --replicas=2 -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you&#8217;ve got one instance of <code>recommendation-v2</code> that is misbehaving and another one that is working correctly.
Let&#8217;s redirect all traffic to <code>recommendation-v2</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/destination-rule-recommendation-v1-v2.yml">istiofiles/destination-rule-recommendation-v1-v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v2.yml">istiofiles/virtual-service-recommendation-v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s perform a load test in our system with <code>siege</code>.
We&#8217;ll have 10 clients sending 4 concurrent requests each:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">siege -r 10 -c 4 -v $GATEWAY_URL/customer</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see an output similar to this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/siege_ok.png" alt="siege output with all successful requests"></span></p>
</div>
<div class="paragraph">
<p>All of the requests to our system were successful.</p>
</div>
<div class="paragraph">
<p>So the <strong>automatic</strong> retries are working as expected.
So far so good, the error is never send back to the client.
But inspect the logs of the failing pod again:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Substitute the pod name to your pod name.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl logs recommendation-v2-2815683430-vpx4p -c recommendation -n tutorial</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">recommendation request from 'recommendation-v2-2815683430-vpx4p': 35
recommendation request from 'recommendation-v2-2815683430-vpx4p': 36
recommendation request from 'recommendation-v2-2815683430-vpx4p': 37
recommendation request from 'recommendation-v2-2815683430-vpx4p': 38</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the number of requests has been increased by an order of 20.
The reason is that the requests are still able to reach the failing service, so even though all consecutive requests to failing pod will fail, Istio is still sending traffic to this failing pod.</p>
</div>
<div class="paragraph">
<p>This is where the <em>Circuit Breaker</em> comes into the scene.</p>
</div>
</div>
<div class="sect2">
<h3 id="circuitbreaker"><a class="anchor" href="#circuitbreaker"></a>Load test with circuit breaker</h3>
<div class="paragraph">
<p>Circuit breaker and pool ejection are used to avoid reaching a failing pod for a specified amount of time.
In this way when some consecutive errors are produced, the failing pod is ejected from eligible pods and all further requests are not sent anymore to that instance but to a healthy instance.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl replace -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/destination-rule-recommendation_cb_policy_version_v2.yml">istiofiles/destination-rule-recommendation_cb_policy_version_v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">siege -r 10 -c 4 -v $GATEWAY_URL/customer</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see an output similar to this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/siege_ok.png" alt="siege output with all successful requests"></span></p>
</div>
<div class="paragraph">
<p>All of the requests to our system were successful.</p>
</div>
<div class="paragraph">
<p>But now inspect again the logs of the failing pod:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl logs recommendation-v2-2815683430-vpx4p -c recommendation -n tutorial</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">recommendation request from 'recommendation-v2-2815683430-vpx4p': 38
recommendation request from 'recommendation-v2-2815683430-vpx4p': 39
recommendation request from 'recommendation-v2-2815683430-vpx4p': 40</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Substitute the pod name to your pod name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now the request is only send to this pod once or twice until the circuit is tripped and pod is ejected.
After this, no further request is send to failing pod.</p>
</div>
</div>
<div class="sect2">
<h3 id="_clean_up_2"><a class="anchor" href="#_clean_up_2"></a>Clean up</h3>
<div class="paragraph">
<p>Remove Istio resources:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/destination-rule-recommendation_cb_policy_version_v2.yml">istiofiles/destination-rule-recommendation_cb_policy_version_v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v2.yml">istiofiles/virtual-service-recommendation-v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scale down to one instance of <code>recommendation-v2</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl scale deployment recommendation-v2 --replicas=1 -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart <code>recommendation-v2</code> pod:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete pod -l app=recommendation,version=v2</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
