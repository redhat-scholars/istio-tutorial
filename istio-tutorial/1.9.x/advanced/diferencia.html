<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Diferencia and Detecting Regressions :: Istio Tutorial Docs</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/istio-tutorial/istio-tutorial/1.9.x/advanced/diferencia.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/istio-tutorial">Istio Tutorial Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="istio-tutorial" data-version="1.9.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction to Istio Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../1setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#download-tutorial-sources">Download Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#install-minikube">Install Minikube</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#start-kubernetes">Start Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#istioinstallation">Install Istio</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../2deploy-microservices.html">2. Deploy Microservices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deploycustomer">Deploy Customer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deploypreference">Deploy Preference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deployrecommendation">Deploy Recommendation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#redeployingcode">Updating Redeploying Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../3monitoring-tracing.html">3. Observability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#monitoring">Monitoring with Grafana</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../3monitoring-tracing.html#prometheus">Prometheus</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#custommetrics">Custom metrics</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#containermemory">Container memory</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#applicationmetrics">Application metrics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#tracing">Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../3kiali.html">Kiali</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#howkiali">How Kiali Work</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#updatekiali">Update Kiali</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#generatingdata">Generating Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#servicegraph">Service Graph</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#servicelistening">Service Listening</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#istioconf">Istio Config</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#distributedtracing">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#cleanup">Uninstall Kiali</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Traffic Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html">Simple Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4simple-routerules.html#deployrecommendationv2">Deploy Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html#istiorouting">Changing Istio Routings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv2">All Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1v2">All Users To Recommendation V1 and V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#canarydeploymentrecommendation">Canary Deployment Between v1 And v2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html">Advanced Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html#canarydeploymentuseragent">Canary Deployment based on user-agent</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#safaritov2">All Safari Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#mobiletov2">All Mobile Users To Recommendation V2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#mirroringtraffic">Mirroring Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#loadbalancer">Load Balancer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html">5. Service Resiliency</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#retry">Retry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#timeout">Timeout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html#failfast">Fail Fast</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#nocircuitbreaker">No Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#circuitbreaker">Circuit Breaker</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../6fault-injection.html">6. Chaos Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#503error">HTTP 503 Error</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#delay">Delay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">7. Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8egress.html">Egress</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8egress.html#createrecommendationv3">Create Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8egress.html#istioegress">Istio-ize Egress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8acl.html">Access Control</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8acl.html#authpolicies">Authorization Policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8mTLS.html">Mutual TLS and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8mTLS.html#testingtls">Testing mTLS</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8jwt.html">End-user authentication with JWT</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8jwt.html#enablingauthentication">Enabling end-user authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8jwt.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8rbac.html">Istio Role Based Access Control (RBAC)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#authorization-jwt">Authorization and JWT</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#final-notes">Final Notes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#8tips.adoc">10. Tips And Tricks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Advanced Istio Tutorial</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="virtualization.html">Service Virtualization and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="virtualization.html#deploypreferencev2">Deploy Preference V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="virtualization.html#servicevirtualization">Adding Service Virtualization</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="virtualization.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="diferencia.html">Diferencia and Detecting Regressions</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#what-is-diferencia">What is Diferencia?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#master-candidate">Setting Master Candidate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deploying-diferencia">Deploying Diferencia</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#shadowing-traffic">Shadowing Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#noise-detection">Noise Detection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#cleanup">Clean up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="promotion.html">Istio for Promoting Services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="promotion.html#what-is-promotion">What is Promotion?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="promotion.html#deploy-recommendation-v3">Deploy Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="promotion.html#feature-graduation]">Feature Graduation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="promotion.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="zero-downtime-database.html">Zero Downtime Migration with Database</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Starting the Migration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="zero-downtime-database.html#recommendationv4">Deploy Recommendation V4</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="zero-downtime-database.html#recommendationv5">Deploy Recommendation V5</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="zero-downtime-database.html#recommendationv6">Deploy Recommendation V6</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="zero-downtime-database.html#recommendationv7">Deploy Recommendation V7</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="zero-downtime-database.html#finalstep">Final Step</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="zero-downtime-database.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="cube.html">Dark Launch Automatic Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#preparation">Preparation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#explanation">Explanation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#code">Source Code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#restore">Restore Environment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Istio Tutorial</a></li>
    <li><a href="index.html">Advanced Istio Tutorial</a></li>
    <li><a href="diferencia.html">Diferencia and Detecting Regressions</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/istio-tutorial/edit/master/documentation/modules/advanced/pages/diferencia.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Diferencia and Detecting Regressions</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Before Start</div>
<div class="paragraph">
<p>You should have NO virtualservice nor destinationrule (in <code>tutorial</code> namespace) <code>kubectl get virtualservice</code> <code>kubectl get destinationrule</code>
if so run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-diferencia"><a class="anchor" href="#what-is-diferencia"></a>What is Diferencia?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://lordofthejars.github.io/diferencia-docs-site"><strong>Diferencia</strong></a> is designed to act as a proxy which intercepts calls to a service and multicast it to several instances of the same service.
These instances are an old and new version of the service. Then when the response is returned from each instance, Diferencia will check if both responses are <em>similar</em>, and if it is the case, then the two implementations might be considered compatible and the new version implementation is <strong>regression-free</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diferencia-simple.png" alt="Overview of Diferencia">
</div>
</div>
<div class="paragraph">
<p>In the previous schema, you can see that a request is multicasted to two instances of Service A, one being V1 and to other V2.
Both return a response and then it is compared by Diferencia.
Finally, notice that no response is returned (<em>by default</em>) but the result (in form of HTTP Status Code).</p>
</div>
<div class="paragraph">
<p>Since Diferencia does not return a real response, but a comparison, effectively means that it is a perfect fit for <strong>Traffic Shadowing/Mirroring</strong> technique.</p>
</div>
<div class="sect2">
<h3 id="master-candidate"><a class="anchor" href="#master-candidate"></a>Selecting Master and Candidate</h3>
<div class="paragraph">
<p>The first thing you need to do is selecting a <strong>master</strong> service (the one you know it works) and a <strong>candidate</strong> service (the one you want to release) and create a Kubernetes service.
For this case, <strong>master</strong> is <code>recommendation:v1</code> and <strong>candidate</strong> is <code>recommendation:v2</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-master-svc.yml">diferencia/recommendation-master-svc.yml</a> -n tutorial
oc create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-candidate-svc.yml">diferencia/recommendation-candidate-svc.yml</a> -n tutorial

or

kubectl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-master-svc.yml">diferencia/recommendation-master-svc.yml</a> -n tutorial
kubectl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-candidate-svc.yml">diferencia/recommendation-candidate-svc.yml</a> -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploying-diferencia"><a class="anchor" href="#deploying-diferencia"></a>Deploying Diferencia</h3>
<div class="paragraph">
<p>Next thing is to deploy Diferencia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment.yml">diferencia/Deployment.yml</a>) -n tutorial
oc create -f diferencia/Service.yml -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment.yml">diferencia/Deployment.yml</a>) -n tutorial
kubectl create -f diferencia/Service.yml -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="shadowing-traffic"><a class="anchor" href="#shadowing-traffic"></a>Shadowing Traffic</h3>
<div class="paragraph">
<p>The last thing is to just start shadowing traffic between <code>recommendation:v1</code> and diferencia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/destination-rule-recommendation-v1-v2.yml">istiofiles/destination-rule-recommendation-v1-v2.yml</a> -n tutorial

istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml">diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then you can send two requests to the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 8

curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Things to notice here is that for each <code>curl</code> request, the counter is incremented by 2.
Why? Because one request is the one sent to the user and the other one is the one consumed by diferencia.</p>
</div>
<div class="paragraph">
<p>Then how do you check if there is any regression or not?
Diferencia offers different ways:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">logs</dt>
<dd>
<p>If you start Diferencia in <code>debug</code> mode (in this example it is) then you can inspect the results of each request.</p>
</dd>
<dt class="hdlist1">API</dt>
<dd>
<p>There is an endpoint that returns a JSON document with the stats of each request/response. <code>:8082/stats</code>.</p>
</dd>
<dt class="hdlist1">Dashboard</dt>
<dd>
<p>There is a simple HTML dashboard to get the stats. <code>:8082/dashboard</code>.</p>
</dd>
<dt class="hdlist1">Prometheus</dt>
<dd>
<p>All statistics are exposed in Prometheus format. <code>:8081/metrics</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Check the logs of Diferencia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs -f `oc get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia

or

kubectl logs -f `kubectl get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you&#8217;ll see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">time="2018-11-14T12:07:43Z" level=debug msg="URL / is going to be processed"
time="2018-11-14T12:07:43Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:43Z" level=debug msg="Forwarding call to http://recommendation-candidate:8080/"
time="2018-11-14T12:07:43Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:43Z" level=debug msg="Result of comparing http://recommendation-master:8080/ and http://recommendation-candidate:8080/ is false"
time="2018-11-14T12:07:50Z" level=debug msg="URL / is going to be processed"
time="2018-11-14T12:07:50Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:50Z" level=debug msg="Forwarding call to http://recommendation-candidate:8080/"
time="2018-11-14T12:07:50Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:50Z" level=debug msg="Result of comparing http://recommendation-master:8080/ and http://recommendation-candidate:8080/ is false"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And notice that in both cases the response is <code>false</code>.
This means that recommendation v1 and recommendation v2 are not compatible.
The reason of that is because of both responses are not equal (<code>recommendation v1 from '5f97c568c4-rkb8t': 8</code>, <code>recommendation v2 from '5f97cab34c4-r348t': 12</code>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This example uses a text comparison which is fine for this case but not in a real use case. Diferencia is built to work perfectly fine in different scenarios where JSON is the content type. You can read more about how Diferencia works when content is JSON <a href="https://lordofthejars.github.io/diferencia-docs-site/diferencia/0.4.0/run-diferencia.html#modes">here</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="noise-detection"><a class="anchor" href="#noise-detection"></a>Noise Detection</h3>
<div class="paragraph">
<p>Notice that in the previous example we could agree that if <code>recommendation</code> was present, we could say that both services are compatible and they are regression-free.</p>
</div>
<div class="paragraph">
<p>To not make a simple comparision but something a bit more error-prone, Diferencia implements a <a href="https://lordofthejars.github.io/diferencia-docs-site/diferencia/0.4.1/run-diferencia.html#noise">Noise cancellation</a> approach to remove these parts that are dynamic (for example the hostname).</p>
</div>
<div class="paragraph">
<p>And it works like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diferencia-noise.png" alt="Noise Cancellation">
</div>
</div>
<div class="paragraph">
<p>This algorithm sends the request to not two instances but three. Two are the old instances (primary and secondary) and one to the new instance (candidate).</p>
</div>
<div class="paragraph">
<p>The request to primary and secondary returns a valid request (since old instances are the correct ones), then from their responses, Diferencia checks for the differences between both responses.</p>
</div>
<div class="paragraph">
<p>Since both responses are valid (because the source is the same but different instances), the differences that are between them are just noise that should not take into consideration for response validation.</p>
</div>
<div class="paragraph">
<p>Then detected noise is removed from primary and candidate response, and they are compared, if they are equal, then you know that everything is fine.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Of course this is a simple example but in case of the JSON is where noise cancellation is really useful, for example for skipping fields such as time, random numbers, &#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_removes_old_diferencia_instance"><a class="anchor" href="#_removes_old_diferencia_instance"></a>Removes Old Diferencia instance</h4>
<div class="paragraph">
<p>Let&#8217;s remove Diferencia and mirroring.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete deployments recommendation-diferencia
or
kubectl delete deployments recommendation-diferencia

istioctl delete -f diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deploy_diferencia_with_noise_cancellation"><a class="anchor" href="#_deploy_diferencia_with_noise_cancellation"></a>Deploy Diferencia with Noise Cancellation</h4>
<div class="paragraph">
<p>Then let&#8217;s add Diferencia with noise cancellation enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment-noise-detection.yml">diferencia/Deployment-noise-detection.yml</a>) -n tutorial
oc create -f diferencia/Service.yml -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment-noise-detection.yml">diferencia/Deployment-noise-detection.yml</a>) -n tutorial
kubectl create -f diferencia/Service.yml -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then let&#8217;s enable mirroring again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml">diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then you can send two requests to the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 11

curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 14</code></pre>
</div>
</div>
<div class="paragraph">
<p>Things to notice here is that for each <code>curl</code> request, the counter is incremented by 3.
Why? Because one request is the one sent to the user and the other one is the one consumed by diferencia as <em>primary</em> and <em>seconday</em>.</p>
</div>
<div class="paragraph">
<p>Now if you check the logs of Diferencia, you should see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs -f `oc get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia

or

kubectl logs -f `kubectl get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia

time="2018-11-16T08:57:33Z" level=debug msg="URL / is going to be processed"
time="2018-11-16T08:57:33Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-16T08:57:33Z" level=debug msg="Forwarding call to http://recommendation-candidate:8080/"
time="2018-11-16T08:57:33Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-16T08:57:33Z" level=debug msg="Result of comparing http://recommendation-master:8080/ and http://recommendation-candidate:8080/ is true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that now the result is <code>true</code> meaning that both services are equivalent.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This is a simple example using text plain, but <a href="https://lordofthejars.github.io/diferencia-docs-site"><strong>Diferencia</strong></a> is really useful when the output is a JSON format where there can be incompatibilities.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleanup"><a class="anchor" href="#cleanup"></a>Clean Up</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete deployments recommendation-diferencia
or
kubectl delete deployments recommendation-diferencia

oc delete service recommendation-candidate
or
kubectl delete service recommendation-candidate


oc delete service recommendation-master
or
kubectl delete service recommendation-master

istioctl delete -f diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml -n tutorial</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../../_/js/vendor/clipboard.js"></script>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
