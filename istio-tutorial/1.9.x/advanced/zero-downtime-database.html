<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Zero Downtime Migrations :: Istio Tutorial Docs</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/istio-tutorial/istio-tutorial/1.9.x/advanced/zero-downtime-database.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/istio-tutorial">Istio Tutorial Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="istio-tutorial" data-version="1.9.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction to Istio Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../1setup.html">1. Setup &amp; Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#prerequisites">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#istioinstallation">Install Istio</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../2deploy-microservices.html">2. Deploy Microservices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deploycustomer">Deploy the Customer Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#configureingress">Configure Ingress</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#_validate_ingress">Validate Ingress</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deploypreference">Deploy the Preference Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deployrecommendation">Deploy the Recommendation Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#redeployingcode">Updating &amp; Redeploying Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../3monitoring-tracing.html">3. Observability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#simulatetraffic">Simulate Traffic in the Mesh Network</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../3monitoring-tracing.html#monitoring">Grafana</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#_obtaining_the_grafana_url">Obtaining the Grafana URL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <span class="nav-text"><a href="/istio-tutorial/1.9.x/3monitoring-tracing.html#_viewing_istio_dashboards_in_grafana" class="page">Viewing Istio Dashboards in Grafana
</a></span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../3monitoring-tracing.html#prometheus">Prometheus</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#_accessing_the_prometheus_dashboard">Accessing the Prometheus Dashboard</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#custommetrics">Querying Prometheus</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#containermemory">Querying Container Memory Usage</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../3monitoring-tracing.html#tracing">Jaeger</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#_accessing_the_jaeger_dashboard">Accessing the Jaeger Dashboard</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#_viewing_traces">Viewing Traces</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3monitoring-tracing.html#_viewing_detailed_trace_information">Viewing Detailed Trace Information</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../3kiali.html">Kiali</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#howkiali">How Kiali Work</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#updatekiali">Update Kiali</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#generatingdata">Generating Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#servicegraph">Service Graph</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#servicelistening">Service Listening</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#istioconf">Istio Config</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#distributedtracing">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#cleanup">Uninstall Kiali</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Traffic Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html">Simple Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4simple-routerules.html#deployrecommendationv2">Deploy Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html#istiorouting">Changing Istio Routings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv2">All Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1v2">All Users To Recommendation V1 and V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#canarydeploymentrecommendation">Canary Deployment Between v1 And v2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html">Advanced Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html#canarydeploymentuseragent">Canary Deployment based on user-agent</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#safaritov2">All Safari Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#mobiletov2">All Mobile Users To Recommendation V2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#mirroringtraffic">Mirroring Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#loadbalancer">Load Balancer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html">5. Service Resiliency</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#retry">Retry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#timeout">Timeout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html#failfast">Fail Fast</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#nocircuitbreaker">No Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#circuitbreaker">Circuit Breaker</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../6fault-injection.html">6. Chaos Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#503error">HTTP 503 Error</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#delay">Delay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">7. Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8egress.html">Egress</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8egress.html#createrecommendationv3">Create Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8egress.html#istioegress">Istio-ize Egress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8acl.html">Access Control</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8acl.html#authpolicies">Authorization Policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8mTLS.html">Mutual TLS and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8mTLS.html#testingtls">Testing mTLS</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8jwt.html">End-user authentication with JWT</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8jwt.html#enablingauthentication">Enabling end-user authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8jwt.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8rbac.html">Istio Role Based Access Control (RBAC)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#authorization-jwt">Authorization and JWT</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#final-notes">Final Notes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#8tips.adoc">10. Tips And Tricks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Advanced Istio Tutorial</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="virtualization.html">Service Virtualization and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="virtualization.html#deploypreferencev2">Deploy Preference V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="virtualization.html#servicevirtualization">Adding Service Virtualization</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="virtualization.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="diferencia.html">Diferencia and Detecting Regressions</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#what-is-diferencia">What is Diferencia?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#master-candidate">Setting Master Candidate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#deploying-diferencia">Deploying Diferencia</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#shadowing-traffic">Shadowing Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#noise-detection">Noise Detection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#cleanup">Clean up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="promotion.html">Istio for Promoting Services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="promotion.html#what-is-promotion">What is Promotion?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="promotion.html#deploy-recommendation-v3">Deploy Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="promotion.html#feature-graduation]">Feature Graduation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="promotion.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="zero-downtime-database.html">Zero Downtime Migration with Database</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Starting the Migration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#recommendationv4">Deploy Recommendation V4</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#recommendationv5">Deploy Recommendation V5</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#recommendationv6">Deploy Recommendation V6</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="#recommendationv7">Deploy Recommendation V7</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#finalstep">Final Step</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="cube.html">Dark Launch Automatic Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#preparation">Preparation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#explanation">Explanation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#code">Source Code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#restore">Restore Environment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Istio Tutorial</a></li>
    <li><a href="index.html">Advanced Istio Tutorial</a></li>
    <li><a href="zero-downtime-database.html">Zero Downtime Migration with Database</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/istio-tutorial/edit/master/documentation/modules/advanced/pages/zero-downtime-database.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Zero Downtime Migrations</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Before Start</div>
<div class="paragraph">
<p>You should have NO virtualservice, destinationrule, gateway or policy (in <code>tutorial</code> namespace) <code>kubectl get virtualservice</code> <code>kubectl get destinationrule</code> <code>kubectl get gateway</code> <code>kubectl get policy</code>
if so run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, you need to undeploy any <em>recommendation</em> service (v1, v2, v3) that you might have deployed on the cluster.
To undeploy them just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete all -l app=recommendation -n tutorial
or
kubectl delete all -l app=recommendation -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until all <em>recommendation</em> serivces are down.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n tutorial
or
kubectl get pods -n tutorial

NAME                                  READY     STATUS    RESTARTS   AGE
customer-3600192384-fpljb             2/2       Running   0          17m
preference-243057078-8c5hz           2/2       Running   0          15m</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Old Versions of customer and preference</div>
<div class="paragraph">
<p>To run this section you need to deploy the latest <em>customer</em> and <em>preference</em> versions, if you already have these <strong>old</strong> versions of <em>customer</em> and <em>preference</em>, deploy them again with latest sources following <a href="../2deploy-microservices.html" class="page">Deploy Microservices</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="recommendationv4"><a class="anchor" href="#recommendationv4"></a>Deploy recommendation:v4</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_deploy_postgresql_database"><a class="anchor" href="#_deploy_postgresql_database"></a>Deploy PostgreSQL database</h3>
<div class="paragraph">
<p>The first thing you need to do is deploy a PostgreSQL database server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd recommendation/java/vertx

oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/PostgreSQL-deployment.yml">../../kubernetes/PostgreSQL-deployment.yml</a>) -n tutorial
or
kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/PostgreSQL-deployment.yml">../../kubernetes/PostgreSQL-deployment.yml</a>) -n tutorial

oc create -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/PostgreSQL-service.yml">../../kubernetes/PostgreSQL-service.yml</a> -n tutorial
or
kubectl create -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/PostgreSQL-service.yml">../../kubernetes/PostgreSQL-service.yml</a> -n tutorial

# Wait until PotsgresSQL deployed

oc get pods -w -n tutorial
or
kubectl get pods -w -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inspecting_database_changes"><a class="anchor" href="#_inspecting_database_changes"></a>Inspecting Database Changes</h3>
<div class="paragraph">
<p>I recommend that every time you deploy a new <em>recommendation</em> service version or you do a <code>POST</code> call, you inspect how the database (<em>recommendation</em> table) has changed.</p>
</div>
<div class="paragraph">
<p>To do it, you just need to go inside into the <em>postgres</em> container and use <code>psql</code> tool.
Open a new terminal window and run next commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods
or
kubectl get pods

NAME                                 READY     STATUS    RESTARTS   AGE
customer-7dcd544ff9-5j6ml            2/2       Running   0          22m
postgres-6cc7c8bbd5-jqw8r            2/2       Running   0          31m
preference-v1-7f7ddf6c4-fhjtw        2/2       Running   0          21m

kubectl exec -ti postgres-6cc7c8bbd5-jqw8r -c postgres /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, when you are inside the container, you can inspect database changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">psql -U admin recommendation

recommendation=# select * from recommendation;

 id |           name
----+--------------------------
  1 | Star Wars: A New Hope
  2 | Star Trek: First Contact
(2 rows)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_recommendationv4"><a class="anchor" href="#_create_recommendationv4"></a>Create recommendation:v4</h3>
<div class="paragraph">
<p>To create <em>recommendation v4</em>, we need to change one line in <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/java/vertx/pom.xml">pom.xml</a>) of project, and change configuration part from <code>vertx-maven-plugin</code>:</p>
</div>
<div class="paragraph">
<p>Before:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;verticle&gt;com.redhat.developer.demos.recommendation.RecommendationVerticle&lt;/verticle&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;verticle&gt;com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle&lt;/verticle&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_docker_build_if_you_have_access_to_docker_daemon"><a class="anchor" href="#_docker_build_if_you_have_access_to_docker_daemon"></a>Docker build (if you have access to Docker daemon)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package

docker build -t example/recommendation:v4 .

docker images | grep recommendation
example/recommendation                  v4                  b23e37349009        1 minutes ago       438MB
example/recommendation                  v2                  c31e399a9628        5 minutes ago       438MB
example/recommendation                  v1                  f072978d9cf6        8 minutes ago      438MB</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
We have a 4th Deployment to manage the v4 version of recommendation.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v4.yml">../../kubernetes/Deployment-v4.yml</a>) -n tutorial
oc get pods -w -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v4.yml">../../kubernetes/Deployment-v4.yml</a>) -n tutorial
kubectl get pods -w -n tutorial

oc create -f ../../kubernetes/Service.yml
or
kubectl create -f ../../kubernetes/Service.yml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon"><a class="anchor" href="#_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon"></a>OpenShift S2I strategy (if you DON&#8217;T have access to Docker daemon)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package -f recommendation/java/vertx
oc new-app -l app=recommendation,version=v4 --name=recommendation-v4 --context-dir=recommendation/java/vertx -e JAEGER_SERVICE_NAME=recommendation JAEGER_ENDPOINT=http://jaeger-collector.istio-system.svc:14268/api/traces JAEGER_PROPAGATION=b3 JAEGER_SAMPLER_TYPE=const JAEGER_SAMPLER_PARAM=1 JAVA_OPTIONS='-Xms128m -Xmx256m -Djava.net.preferIPv4Stack=true' fabric8/s2i-java~https://github.com/redhat-scholars/istio-tutorial -o yaml  &gt; recommendation-v4.yml
oc apply -f &lt;(istioctl kube-inject -f recommendation-v4.yml) -n tutorial
oc cancel-build bc/recommendation-v4 -n tutorial
oc delete svc/recommendation-v4 -n tutorial
oc start-build recommendation-v4 --from-dir=. --follow -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wait_for_v4_to_be_deployed"><a class="anchor" href="#_wait_for_v4_to_be_deployed"></a>Wait for v4 to be deployed</h4>
<div class="paragraph">
<p>Wait for those pods to show "2/2", the istio-proxy/envoy sidecar is part of that pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                  READY     STATUS    RESTARTS   AGE
customer-3600192384-fpljb             2/2       Running   0          17m
preference-243057078-8c5hz           2/2       Running   0          15m
recommendation-v4-60483540-9snd9     2/2       Running   0          12m</code></pre>
</div>
</div>
<div class="paragraph">
<p>and test the customer endpoint</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io

recommendation v4 [Star Wars: A New Hope,Star Trek: First Contact] from '60483540-9snd9': 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>What you are getting here is a list of recommendations (every time will be the same) which are selected from the database, so it means that any change on the database is reflected to this query.</p>
</div>
<div class="paragraph">
<p>For example, run next command to add a new recommendation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -H "Content-type: text/plain" -X POST --data "Avengers: Infinity War" customer-tutorial.$(minishift ip).nip.io
3</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you don&#8217;t see an integer but a normal GET (<code>customer &#8658; preference &#8658; recommendation v4 [Star Wars: A New Hope,Star Trek: First Contact] from '6d4b86c9fb-ph8rm': 2</code>) this is because you have old versions of customer and preference services deployed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And make a new request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io

recommendation v4 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War] from '60483540-9snd9': 2</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migration"><a class="anchor" href="#migration"></a>Start the migration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What we want to do is one of the most complex operations in terms of database migration, and this is changing the name of a column.
The same process is used for example if you need to change a data type, and it is similar in case of having to add new columns or tables.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Flyway</div>
<div class="paragraph">
<p><a href="https://flywaydb.org/">Flyway</a> is a version control for your database.
It allows you to evolute your database schema (and data) with ease and pleasure.</p>
</div>
<div class="paragraph">
<p>Flyway allows you to have your database migration files altogether with your code.
In summary, any SQL file placed following <em>Flyway_</em> naming convention at <code>src/main/resources/db/migration</code> are executed against a configured database if it has not applied before.</p>
</div>
<div class="paragraph">
<p>And this is the solution used in the <em>recommendation</em> service for dealing with database migrations.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The steps we are going to follow for the migration is by doing 3 versions of the service:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For sake of simplicity we are going to change the major number of the version, but in a real case, you&#8217;ll make it using minor/patch versions.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a new column and make the new service read from the old column and write to both.</p>
</li>
<li>
<p>Copy old data to the new column and code reads from the new column and writes to both.</p>
</li>
<li>
<p>The code reads and writes from the new column.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can create subversions (i.e one version for adding the column, another for making the new service read from old column and write to both) depending on your release process.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is important to follow these steps (no shortcuts) to make your application safe to any rollback in case of an error in the newer version.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So let&#8217;s see the process of updating the column named <em>name</em> to <em>movie_name</em>.</p>
</div>
<div class="sect2">
<h3 id="recommendationv5"><a class="anchor" href="#recommendationv5"></a>Recommendation:v5</h3>
<div class="paragraph">
<p>The first thing to do before releasing <em>recommendation</em> v5 is to add the new column (which would be the final name, in this case, <strong>movie_name</strong>).
To do it execute next command on a terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cp <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/java/vertx/src/main/sql/V2__Add_movie_column_in_recommendation_table.sql">src/main/sql/V2__Add_movie_column_in_recommendation_table.sql</a> src/main/resources/db/migration/V2__Add_movie_column_in_recommendation_table.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then update the <em>recommendation</em> service to a newer version and to write new values to both columns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String RESPONSE_STRING_FORMAT = "recommendation v5 from '%s': %d\n";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open <code>RecommendationPersistenceVerticle</code> class and change <code>start</code> method form:</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">router.post("/").handler(this::addRecommendation);
// router.post("/").handler(this::addRecommendationToBothColumns);</code></pre>
</div>
</div>
<div class="paragraph">
<p>to</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// router.post("/").handler(this::addRecommendation);
router.post("/").handler(this::addRecommendationToBothColumns);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then let&#8217;s build the new version and deploy it to the cluster.</p>
</div>
<div class="sect3">
<h4 id="_docker_build_if_you_have_access_to_docker_daemon_2"><a class="anchor" href="#_docker_build_if_you_have_access_to_docker_daemon_2"></a>Docker build (if you have access to Docker daemon)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package

docker build -t example/recommendation:v5 .

docker images | grep recommendation
example/recommendation                  v5                  a84563734376        1 minutes ago       438MB
example/recommendation                  v4                  b23e37349009        1 minutes ago       438MB
example/recommendation                  v2                  c31e399a9628        5 minutes ago       438MB
example/recommendation                  v1                  f072978d9cf6        8 minutes ago      438MB</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
We have a 5th Deployment to manage the v4 version of recommendation.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v5.yml">../../kubernetes/Deployment-v5.yml</a>) -n tutorial
oc get pods -w -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v5.yml">../../kubernetes/Deployment-v5.yml</a>) -n tutorial
kubectl get pods -w -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon_2"><a class="anchor" href="#_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon_2"></a>OpenShift S2I strategy (if you DON&#8217;T have access to Docker daemon)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package -f recommendation/java/vertx
oc new-app -l app=recommendation,version=v5 --name=recommendation-v5 --context-dir=recommendation/java/vertx -e JAEGER_SERVICE_NAME=recommendation JAEGER_ENDPOINT=http://jaeger-collector.istio-system.svc:14268/api/traces JAEGER_PROPAGATION=b3 JAEGER_SAMPLER_TYPE=const JAEGER_SAMPLER_PARAM=1 JAVA_OPTIONS='-Xms128m -Xmx256m -Djava.net.preferIPv4Stack=true' fabric8/s2i-java~https://github.com/redhat-scholars/istio-tutorial -o yaml  &gt; recommendation-v5.yml
oc apply -f &lt;(istioctl kube-inject -f recommendation-v5.yml) -n tutorial
oc cancel-build bc/recommendation-v5 -n tutorial
oc delete svc/recommendation-v5 -n tutorial
oc start-build recommendation-v5 --from-dir=. --follow -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wait_for_v5_to_be_deployed"><a class="anchor" href="#_wait_for_v5_to_be_deployed"></a>Wait for v5 to be deployed</h4>
<div class="paragraph">
<p>Wait for those pods to show "2/2", the istio-proxy/envoy sidecar is part of that pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                  READY     STATUS    RESTARTS   AGE
customer-3600192384-fpljb             2/2       Running   0          17m
preference-243057078-8c5hz           2/2       Running   0          15m
recommendation-v4-60483540-9snd9     2/2       Running   0          12m
recommendation-v5-00979354-89fga     2/2       Running   0          11m</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_blue_green_deployment_between_v4_and_v5"><a class="anchor" href="#_blue_green_deployment_between_v4_and_v5"></a>Blue-Green Deployment between v4 and v5</h4>
<div class="paragraph">
<p>Now we can start the release process of <em>recommendation</em> v5.
Let&#8217;s redirect all traffic to v4.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/destination-rule-recommendation-v4-v5-v6-v7.yml">../../../istiofiles/destination-rule-recommendation-v4-v5-v6-v7.yml</a> -n tutorial
istioctl create -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v4.yml">../../../istiofiles/virtual-service-recommendation-v4.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io

recommendation v4 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War] from '60483540-9snd9': 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s redirect traffic to v5:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v5.yml">../../../istiofiles/virtual-service-recommendation-v5.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And apply some requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
recommendation v5 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War] from '00979354-89fga': 1

curl -H "Content-type: text/plain" -X POST --data "Frozen" customer-tutorial.$(minishift ip).nip.io
3

curl customer-tutorial.$(minishift ip).nip.io
recommendation v5 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War, Frozen] from '00979354-89fga': 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>What&#8217;s happening if we find some problems in <em>v5</em> ? We just need to redirect traffic back to v4.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v4.yml">istiofiles/virtual-service-recommendation-v4.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io

recommendation v4 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War, Frozen] from '60483540-9snd9': 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that even though, it is the old version, the content added during v5 was released is still available and no data lost has ocurred.
Next step (executed by DB administrator) could be just removing the <strong>movie_name</strong> column.</p>
</div>
<div class="paragraph">
<p>But let&#8217;s suppose that <em>v5</em> has no errors and it is going to be the correct release:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v5.yml">istiofiles/virtual-service-recommendation-v5.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we can undeploy the <em>recommendation</em> v4 service from the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete all -l app=recommendation,version=v4
or
kubectl delete all -l app=recommendation,version=v4</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="recommendationv6"><a class="anchor" href="#recommendationv6"></a>Recommendation:v6</h3>
<div class="paragraph">
<p>The first thing to do before releasing <em>recommendation</em> v6 is to copy old data (<strong>name</strong> column) to the new column (<strong>movie_name</strong>).
Usually, if the column contains a lot of entries, you&#8217;ll do it using a batch process, but for the sake of simplicity, a simple SQL update is executed in this case.
To do it execute next command on a terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cp <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/java/vertx/src/main/sql/V3__Update_recommendation_data.sql">src/main/sql/V3__Update_recommendation_data.sql</a> src/main/resources/db/migration/V3__Update_recommendation_data.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then update code so the reads are happening from the new column and write to both.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String RESPONSE_STRING_FORMAT = "recommendation v6 from '%s': %d\n";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open <code>RecommendationPersistenceVerticle</code> class and change <code>getRecommendationsFromDb</code> method form:</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final List&lt;String&gt; recommendations = findRecommendation(resultSet);
// final List&lt;String&gt; recommendations = findRecommendationNew(resultSet);</code></pre>
</div>
</div>
<div class="paragraph">
<p>to</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// final List&lt;String&gt; recommendations = findRecommendation(resultSet);
final List&lt;String&gt; recommendations = findRecommendationNew(resultSet);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then let&#8217;s build the new version and deploy it to the cluster.</p>
</div>
<div class="sect3">
<h4 id="_docker_build_if_you_have_access_to_docker_daemon_3"><a class="anchor" href="#_docker_build_if_you_have_access_to_docker_daemon_3"></a>Docker build (if you have access to Docker daemon)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package

docker build -t example/recommendation:v6 .

docker images | grep recommendation
example/recommendation                  v6                  345bb6773434        1 minutes ago       438MB
example/recommendation                  v5                  a84563734376        1 minutes ago       438MB
example/recommendation                  v4                  b23e37349009        1 minutes ago       438MB
example/recommendation                  v2                  c31e399a9628        5 minutes ago       438MB
example/recommendation                  v1                  f072978d9cf6        8 minutes ago      438MB</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
We have a 6th Deployment to manage the v4 version of recommendation.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v6.yml">../../kubernetes/Deployment-v6.yml</a>) -n tutorial
oc get pods -w -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v6.yml">../../kubernetes/Deployment-v6.yml</a>) -n tutorial
kubectl get pods -w -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon_3"><a class="anchor" href="#_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon_3"></a>OpenShift S2I strategy (if you DON&#8217;T have access to Docker daemon)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package -f recommendation/java/vertx
oc new-app -l app=recommendation,version=v6 --name=recommendation-v6 --context-dir=recommendation/java/vertx -e JAEGER_SERVICE_NAME=recommendation JAEGER_ENDPOINT=http://jaeger-collector.istio-system.svc:14268/api/traces JAEGER_PROPAGATION=b3 JAEGER_SAMPLER_TYPE=const JAEGER_SAMPLER_PARAM=1 JAVA_OPTIONS='-Xms128m -Xmx256m -Djava.net.preferIPv4Stack=true' fabric8/s2i-java~https://github.com/redhat-scholars/istio-tutorial -o yaml  &gt; recommendation-v6.yml
oc apply -f &lt;(istioctl kube-inject -f recommendation-v6.yml) -n tutorial
oc cancel-build bc/recommendation-v6 -n tutorial
oc delete svc/recommendation-v6 -n tutorial
oc start-build recommendation-v6 --from-dir=. --follow -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wait_for_v6_to_be_deployed"><a class="anchor" href="#_wait_for_v6_to_be_deployed"></a>Wait for v6 to be deployed</h4>
<div class="paragraph">
<p>Wait for those pods to show "2/2", the istio-proxy/envoy sidecar is part of that pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                  READY     STATUS    RESTARTS   AGE
customer-3600192384-fpljb             2/2       Running   0          17m
preference-243057078-8c5hz           2/2       Running   0          15m
recommendation-v5-00979354-89fga     2/2       Running   0          11m
recommendation-v6-98b29894-64g45     2/2       Running   0          11m</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_blue_green_deployment_between_v5_and_v6"><a class="anchor" href="#_blue_green_deployment_between_v5_and_v6"></a>Blue-Green Deployment between v5 and v6</h4>
<div class="paragraph">
<p>Now, let&#8217;s redirect traffic to v6:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v6.yml">istiofiles/virtual-service-recommendation-v6.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And apply some requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
recommendation v6 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War, Frozen] from '98b29894-64g45': 3

curl -H "Content-type: text/plain" -X POST --data "The Lord Of The Rings: The Fellowship of the Ring" customer-tutorial.$(minishift ip).nip.io
5

curl customer-tutorial.$(minishift ip).nip.io
recommendation v6 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War, Frozen, The Lord Of The Rings: The Fellowship of the Ring] from '98b29894-64g45': 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>What&#8217;s happening if we find some problems in <em>v6</em> ? We just need to redirect traffic back to v5.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v5.yml">istiofiles/virtual-service-recommendation-v5.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io

recommendation v5 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War, Frozen, The Lord Of The Rings: The Fellowship of the Ring] from '00979354-89fga': 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>So again no data lost and rolling back the service has no consequences.</p>
</div>
<div class="paragraph">
<p>But let&#8217;s suppose that <em>v6</em> has no errors and it is going to be the correct release:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v6.yml">istiofiles/virtual-service-recommendation-v6.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we can undeploy the <em>recommendation</em> v5 service from the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete all -l app=recommendation,version=v5
or
kubectl delete all -l app=recommendation,version=v5</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="recommendationv7"><a class="anchor" href="#recommendationv7"></a>Recommendation:v7</h3>
<div class="paragraph">
<p>The last thing to do is just write every time to the new column <strong>movie_name</strong> and not both.
Also, it implies removing the null constraint and add it to the new column.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cp <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/java/vertx/src/main/sql/V4__Update_movie_name_constraints.sql">src/main/sql/V4__Update_movie_name_constraints.sql</a> src/main/resources/db/migration/V4__Update_movie_name_constraints.sql</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String RESPONSE_STRING_FORMAT = "recommendation v7 from '%s': %d\n";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open <code>RecommendationPersistenceVerticle</code> class and change <code>getRecommendationsFromDb</code> method form:</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">router.post("/").handler(this::addRecommendationToBothColumns);
// router.post("/").handler(this::addRecommendationToNewColumn);</code></pre>
</div>
</div>
<div class="paragraph">
<p>to</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// router.post("/").handler(this::addRecommendationToBothColumns);
router.post("/").handler(this::addRecommendationToNewColumn);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then let&#8217;s build the new version and deploy it to the cluster.</p>
</div>
<div class="sect3">
<h4 id="_docker_build_if_you_have_access_to_docker_daemon_4"><a class="anchor" href="#_docker_build_if_you_have_access_to_docker_daemon_4"></a>Docker build (if you have access to Docker daemon)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package

docker build -t example/recommendation:v7 .

docker images | grep recommendation
example/recommendation                  v7                  f449867a2342        2 minutes ago       438MB
example/recommendation                  v6                  345bb6773434        3 minutes ago       438MB
example/recommendation                  v5                  a84563734376        8 minutes ago       438MB
example/recommendation                  v4                  b23e37349009        9 minutes ago       438MB
example/recommendation                  v2                  c31e399a9628        12 minutes ago       438MB
example/recommendation                  v1                  f072978d9cf6        15 minutes ago      438MB</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
We have a 7th Deployment to manage the v4 version of recommendation.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v7.yml">../../kubernetes/Deployment-v7.yml</a>) -n tutorial
oc get pods -w -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v7.yml">../../kubernetes/Deployment-v7.yml</a>) -n tutorial
kubectl get pods -w -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon_4"><a class="anchor" href="#_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon_4"></a>OpenShift S2I strategy (if you DON&#8217;T have access to Docker daemon)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package -f recommendation/java/vertx
oc new-app -l app=recommendation,version=v7 --name=recommendation-v7 --context-dir=recommendation/java/vertx -e JAEGER_SERVICE_NAME=recommendation JAEGER_ENDPOINT=http://jaeger-collector.istio-system.svc:14268/api/traces JAEGER_PROPAGATION=b3 JAEGER_SAMPLER_TYPE=const JAEGER_SAMPLER_PARAM=1 JAVA_OPTIONS='-Xms128m -Xmx256m -Djava.net.preferIPv4Stack=true' fabric8/s2i-java~https://github.com/redhat-scholars/istio-tutorial -o yaml  &gt; recommendation-v7.yml
oc apply -f &lt;(istioctl kube-inject -f recommendation-v7.yml) -n tutorial
oc cancel-build bc/recommendation-v7 -n tutorial
oc delete svc/recommendation-v7 -n tutorial
oc start-build recommendation-v7 --from-dir=. --follow -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wait_for_v7_to_be_deployed"><a class="anchor" href="#_wait_for_v7_to_be_deployed"></a>Wait for v7 to be deployed</h4>
<div class="paragraph">
<p>Wait for those pods to show "2/2", the istio-proxy/envoy sidecar is part of that pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                  READY     STATUS    RESTARTS   AGE
customer-3600192384-fpljb             2/2       Running   0          17m
preference-243057078-8c5hz           2/2       Running   0          15m
recommendation-v6-98b29894-64g45     2/2       Running   0          11m
recommendation-v7-bb452a56-45tg2     2/2       Running   0          10m</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_blue_green_deployment_between_v6_and_v7"><a class="anchor" href="#_blue_green_deployment_between_v6_and_v7"></a>Blue-Green Deployment between v6 and v7</h4>
<div class="paragraph">
<p>Now, let&#8217;s redirect traffic to v7:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v7.yml">istiofiles/virtual-service-recommendation-v7.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And apply some requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
recommendation v7 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War, Frozen, The Lord Of The Rings: The Fellowship of the Ring] from 'bb452a56-45tg2': 4

curl -H "Content-type: text/plain" -X POST --data "Howl's Moving Castle" customer-tutorial.$(minishift ip).nip.io
6

curl customer-tutorial.$(minishift ip).nip.io
recommendation v7 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War, Frozen, The Lord Of The Rings: The Fellowship of the Ring, Howl's Moving Castle] from 'bb452a56-45tg2': 5</code></pre>
</div>
</div>
<div class="paragraph">
<p>What&#8217;s happening if we find some problems in <em>v7</em> ? We just need to redirect traffic back to v6.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v6.yml">istiofiles/virtual-service-recommendation-v6.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io

curl customer-tutorial.$(minishift ip).nip.io
recommendation v6 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War, Frozen, The Lord Of The Rings: The Fellowship of the Ring, Howl's Moving Castle] from '98b29894-64g45': 6

curl -H "Content-type: text/plain" -X POST --data "The Pink Panther" customer-tutorial.$(minishift ip).nip.io
7</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now v7 is fixed and released again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/istiofiles/virtual-service-recommendation-v7.yml">istiofiles/virtual-service-recommendation-v7.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
recommendation v6 [Star Wars: A New Hope,Star Trek: First Contact, Avengers: Infinity War, Frozen, The Lord Of The Rings: The Fellowship of the Ring, Howl's Moving Castle, The Pink Panther] from '98b29894-64g45': 7</code></pre>
</div>
</div>
<div class="paragraph">
<p>So no data lose, every step we follow is safe, and at any time we are able to roll back to last known working version without any problem and when the new version is released again, everything still works.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="finalstep"><a class="anchor" href="#finalstep"></a>Final Step</h3>
<div class="paragraph">
<p>The final step that should be done by a DB administrator for example when maintenance window is set, and it is to delete the old column since the new version of the service is not using it anymore for reading nor for writing.
Keep in mind that this is a destructive operation so, it should be taken with care.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleanup"><a class="anchor" href="#cleanup"></a>Cleanup</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete all -l app=recommendation
or
kubectl delete all -l app=recommendation

oc delete all -l app=postgres
or
kubectl delete all -l app=postgres

istioctl delete -f istiofiles/destination-rule-recommendation-v4-v5-v6-v7.yml -n tutorial
istioctl create -f istiofiles/virtual-service-recommendation-v7.yml -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then let&#8217;s redeploy <em>recommendation</em> v1 and v2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd recommendation/java/vertx

oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v1.yml">../../kubernetes/Deployment-v1.yml</a>) -n tutorial
or
kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v1.yml">../../kubernetes/Deployment-v1.yml</a>) -n tutorial

oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v2.yml">../../kubernetes/Deployment-v2.yml</a>) -n tutorial
or
kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v2.yml">../../kubernetes/Deployment-v2.yml</a>) -n tutorial

oc create -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Service.yml">../../kubernetes/Service.yml</a>
oc get pods -w
or
kubectl create -f <a href="https://github.com/redhat-scholars/istio-tutorial/blob/master/recommendation/kubernetes/Service.yml">../../kubernetes/Service.yml</a>
kubectl get pods -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to rollback the code of <em>recommendation</em> service to initial stages, you need to do next changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Rollback code changes in <code>RecommendationPersistenceVerticle</code> class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From:</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// final List&lt;String&gt; recommendations = findRecommendation(resultSet);
final List&lt;String&gt; recommendations = findRecommendationNew(resultSet);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To:</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final List&lt;String&gt; recommendations = findRecommendation(resultSet);
// final List&lt;String&gt; recommendations = findRecommendationNew(resultSet);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And from:</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// router.post("/").handler(this::addRecommendation);
// router.post("/").handler(this::addRecommendationToBothColumns);
router.post("/").handler(this::addRecommendationToNewColumn);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To:</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">router.post("/").handler(this::addRecommendation);
router.post("/").handler(this::addRecommendationToBothColumns);
// router.post("/").handler(this::addRecommendationToNewColumn);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And from:</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String RESPONSE_STRING_FORMAT = "recommendation v7 from '%s': %d\n";</code></pre>
</div>
</div>
<div class="paragraph">
<p>To:</p>
</div>
<div class="listingblock">
<div class="title">com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String RESPONSE_STRING_FORMAT = "recommendation v4 from '%s': %d\n";</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Remove next SQL scripts:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">rm src/main/resources/db/migration/V2__Add_movie_column_in_recommendation_table.sql
rm src/main/resources/db/migration/V3__Update_recommendation_data.sql
rm src/main/resources/db/migration/V4__Update_movie_name_constraints.sql</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Set correct verticle:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;verticle&gt;com.redhat.developer.demos.recommendation.RecommendationPersistenceVerticle&lt;/verticle&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;verticle&gt;com.redhat.developer.demos.recommendation.RecommendationVerticle&lt;/verticle&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../../_/js/vendor/clipboard.js"></script>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
