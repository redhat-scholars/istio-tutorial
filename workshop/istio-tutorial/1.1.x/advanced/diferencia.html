<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diferencia and Detecting Regressions :: Istio Workshop</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/istio-tutorial/workshop/istio-tutorial/1.1.x/advanced/diferencia.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="#">Istio Tutorial</a>
        <span class="separator">//</span>
        <a href="https://redhat-developer-demos.github.io/istio-tutorial/workshop">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Project</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/istio-tutorial">Istio Tutorial Repository</a>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/istio-tutorial/issues">Istio Tutorial Issue Tracker</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/rhdevelopers">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header><div class="main-wrapper">
<div class="navigation-container" data-component="istio-tutorial" data-version="1.1.x">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Istio Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction to Istio Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../workshop/1setup.html">1. Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../workshop/2deploy-microservices.html">2. Deploy Microservices</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../3monitoring-tracing.html">3. Observability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#monitoring">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#tracing">Tracing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">4. Traffic Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html">Simple Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4simple-routerules.html#deployrecommendationv2">Create Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html#istiorouting">Changing Istio Routings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv2">All Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1v2">All Users To Recommendation V1 and V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#canarydeploymentrecommendation">Canary Deployment Between v1 And v2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html">Advanced Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html#canarydeploymentuseragent">Canary Deployment based on user-agent</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#safaritov2">All Safari Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#mobiletov2">All Mobile Users To Recommendation V2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#mirroringtraffic">Mirroring Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#loadbalancer">Load Balancer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html">5. Service Resiliency</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#retry">Retry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#timeout">Timeout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html#failfast">Fail Fast</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#nocircuitbreaker">No Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#circuitbreaker">Circuit Breaker</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html#poolejection">Pool Ejection - not neeed in 1.1</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#nofailinginstances">No Failing Instance</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#failinginstancesnopoolejection">Failing Instance No Pool Ejection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#failinginstancespoolejection">Failing Instance Pool Ejection</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#circuitbreakerandpoolejection">Circuit Breaker + Pool Ejection - not needed with 1.1 </a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../6fault-injection.html">6. Chaos Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#503error">HTTP 503 Error</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#delay">Delay</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Istio Tutorial</span>
    <span class="version">1.1.x</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Istio Tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.1.x</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="../index.html">Istio Tutorial</a></li>
    <li class="crumb"><a href="diferencia.html">Diferencia and Detecting Regressions</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/documentation/modules/advanced/pages/diferencia.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Diferencia and Detecting Regressions</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Before Start</div>
<div class="paragraph">
<p>You should have NO virtualservice nor destinationrule (in <code>tutorial</code> namespace) <code>kubectl get virtualservice</code> <code>kubectl get destinationrule</code>
if so run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-diferencia"><a class="anchor" href="#what-is-diferencia"></a>What is Diferencia?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://lordofthejars.github.io/diferencia-docs-site"><strong>Diferencia</strong></a> is designed to act as a proxy which intercepts calls to a service and multicast it to several instances of the same service.
These instances are an old and new version of the service. Then when the response is returned from each instance, Diferencia will check if both responses are <em>similar</em>, and if it is the case, then the two implementations might be considered compatible and the new version implementation is <strong>regression-free</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diferencia-simple.png" alt="Overview of Diferencia">
</div>
</div>
<div class="paragraph">
<p>In the previous schema, you can see that a request is multicasted to two instances of Service A, one being V1 and to other V2.
Both return a response and then it is compared by Diferencia.
Finally, notice that no response is returned (<em>by default</em>) but the result (in form of HTTP Status Code).</p>
</div>
<div class="paragraph">
<p>Since Diferencia does not return a real response, but a comparison, effectively means that it is a perfect fit for <strong>Traffic Shadowing/Mirroring</strong> technique.</p>
</div>
<div class="sect2">
<h3 id="master-candidate"><a class="anchor" href="#master-candidate"></a>Selecting Master and Candidate</h3>
<div class="paragraph">
<p>The first thing you need to do is selecting a <strong>master</strong> service (the one you know it works) and a <strong>candidate</strong> service (the one you want to release) and create a Kubernetes service.
For this case, <strong>master</strong> is <code>recommendation:v1</code> and <strong>candidate</strong> is <code>recommendation:v2</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-master-svc.yml">diferencia/recommendation-master-svc.yml</a> -n tutorial
oc create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-candidate-svc.yml">diferencia/recommendation-candidate-svc.yml</a> -n tutorial

or

kubectl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-master-svc.yml">diferencia/recommendation-master-svc.yml</a> -n tutorial
kubectl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-candidate-svc.yml">diferencia/recommendation-candidate-svc.yml</a> -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploying-diferencia"><a class="anchor" href="#deploying-diferencia"></a>Deploying Diferencia</h3>
<div class="paragraph">
<p>Next thing is to deploy Diferencia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment.yml">diferencia/Deployment.yml</a>) -n tutorial
oc create -f diferencia/Service.yml -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment.yml">diferencia/Deployment.yml</a>) -n tutorial
kubectl create -f diferencia/Service.yml -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="shadowing-traffic"><a class="anchor" href="#shadowing-traffic"></a>Shadowing Traffic</h3>
<div class="paragraph">
<p>The last thing is to just start shadowing traffic between <code>recommendation:v1</code> and diferencia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/destination-rule-recommendation-v1-v2.yml">istiofiles/destination-rule-recommendation-v1-v2.yml</a> -n tutorial

istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml">diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then you can send two requests to the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 8

curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Things to notice here is that for each <code>curl</code> request, the counter is incremented by 2.
Why? Because one request is the one sent to the user and the other one is the one consumed by diferencia.</p>
</div>
<div class="paragraph">
<p>Then how do you check if there is any regression or not?
Diferencia offers different ways:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">logs</dt>
<dd>
<p>If you start Diferencia in <code>debug</code> mode (in this example it is) then you can inspect the results of each request.</p>
</dd>
<dt class="hdlist1">API</dt>
<dd>
<p>There is an endpoint that returns a JSON document with the stats of each request/response. <code>:8082/stats</code>.</p>
</dd>
<dt class="hdlist1">Dashboard</dt>
<dd>
<p>There is a simple HTML dashboard to get the stats. <code>:8082/dashboard</code>.</p>
</dd>
<dt class="hdlist1">Prometheus</dt>
<dd>
<p>All statistics are exposed in Prometheus format. <code>:8081/metrics</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Check the logs of Diferencia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs -f `oc get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia

or

kubectl logs -f `kubectl get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you&#8217;ll see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">time="2018-11-14T12:07:43Z" level=debug msg="URL / is going to be processed"
time="2018-11-14T12:07:43Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:43Z" level=debug msg="Forwarding call to http://recommendation-candidate:8080/"
time="2018-11-14T12:07:43Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:43Z" level=debug msg="Result of comparing http://recommendation-master:8080/ and http://recommendation-candidate:8080/ is false"
time="2018-11-14T12:07:50Z" level=debug msg="URL / is going to be processed"
time="2018-11-14T12:07:50Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:50Z" level=debug msg="Forwarding call to http://recommendation-candidate:8080/"
time="2018-11-14T12:07:50Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:50Z" level=debug msg="Result of comparing http://recommendation-master:8080/ and http://recommendation-candidate:8080/ is false"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And notice that in both cases the response is <code>false</code>.
This means that recommendation v1 and recommendation v2 are not compatible.
The reason of that is because of both responses are not equal (<code>recommendation v1 from '5f97c568c4-rkb8t': 8</code>, <code>recommendation v2 from '5f97cab34c4-r348t': 12</code>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This example uses a text comparison which is fine for this case but not in a real use case. Diferencia is built to work perfectly fine in different scenarios where JSON is the content type. You can read more about how Diferencia works when content is JSON <a href="https://lordofthejars.github.io/diferencia-docs-site/diferencia/0.4.0/run-diferencia.html#modes">here</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="noise-detection"><a class="anchor" href="#noise-detection"></a>Noise Detection</h3>
<div class="paragraph">
<p>Notice that in the previous example we could agree that if <code>recommendation</code> was present, we could say that both services are compatible and they are regression-free.</p>
</div>
<div class="paragraph">
<p>To not make a simple comparision but something a bit more error-prone, Diferencia implements a <a href="https://lordofthejars.github.io/diferencia-docs-site/diferencia/0.4.1/run-diferencia.html#noise">Noise cancellation</a> approach to remove these parts that are dynamic (for example the hostname).</p>
</div>
<div class="paragraph">
<p>And it works like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diferencia-noise.png" alt="Noise Cancellation">
</div>
</div>
<div class="paragraph">
<p>This algorithm sends the request to not two instances but three. Two are the old instances (primary and secondary) and one to the new instance (candidate).</p>
</div>
<div class="paragraph">
<p>The request to primary and secondary returns a valid request (since old instances are the correct ones), then from their responses, Diferencia checks for the differences between both responses.</p>
</div>
<div class="paragraph">
<p>Since both responses are valid (because the source is the same but different instances), the differences that are between them are just noise that should not take into consideration for response validation.</p>
</div>
<div class="paragraph">
<p>Then detected noise is removed from primary and candidate response, and they are compared, if they are equal, then you know that everything is fine.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Of course this is a simple example but in case of the JSON is where noise cancellation is really useful, for example for skipping fields such as time, random numbers, &#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_removes_old_diferencia_instance"><a class="anchor" href="#_removes_old_diferencia_instance"></a>Removes Old Diferencia instance</h4>
<div class="paragraph">
<p>Let&#8217;s remove Diferencia and mirroring.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete deployments recommendation-diferencia
or
kubectl delete deployments recommendation-diferencia

istioctl delete -f diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deploy_diferencia_with_noise_cancellation"><a class="anchor" href="#_deploy_diferencia_with_noise_cancellation"></a>Deploy Diferencia with Noise Cancellation</h4>
<div class="paragraph">
<p>Then let&#8217;s add Diferencia with noise cancellation enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment-noise-detection.yml">diferencia/Deployment-noise-detection.yml</a>) -n tutorial
oc create -f diferencia/Service.yml -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment-noise-detection.yml">diferencia/Deployment-noise-detection.yml</a>) -n tutorial
kubectl create -f diferencia/Service.yml -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then let&#8217;s enable mirroring again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml">diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then you can send two requests to the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 11

curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 14</code></pre>
</div>
</div>
<div class="paragraph">
<p>Things to notice here is that for each <code>curl</code> request, the counter is incremented by 3.
Why? Because one request is the one sent to the user and the other one is the one consumed by diferencia as <em>primary</em> and <em>seconday</em>.</p>
</div>
<div class="paragraph">
<p>Now if you check the logs of Diferencia, you should see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs -f `oc get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia

or

kubectl logs -f `kubectl get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia

time="2018-11-16T08:57:33Z" level=debug msg="URL / is going to be processed"
time="2018-11-16T08:57:33Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-16T08:57:33Z" level=debug msg="Forwarding call to http://recommendation-candidate:8080/"
time="2018-11-16T08:57:33Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-16T08:57:33Z" level=debug msg="Result of comparing http://recommendation-master:8080/ and http://recommendation-candidate:8080/ is true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that now the result is <code>true</code> meaning that both services are equivalent.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This is a simple example using text plain, but <a href="https://lordofthejars.github.io/diferencia-docs-site"><strong>Diferencia</strong></a> is really useful when the output is a JSON format where there can be incompatibilities.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleanup"><a class="anchor" href="#cleanup"></a>Clean Up</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete deployments recommendation-diferencia
or
kubectl delete deployments recommendation-diferencia

oc delete service recommendation-candidate
or
kubectl delete service recommendation-candidate


oc delete service recommendation-master
or
kubectl delete service recommendation-master

istioctl delete -f diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml -n tutorial</code></pre>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This content is brought to you by <a href="http://developers.redhat.com">Red Hat Developer</a> - Register today!.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
